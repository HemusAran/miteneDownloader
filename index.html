<!DOCTYPE html>
<html>
 <head>
 </head>
<body>

<div id="description1"></div>
<input type="text" size="40" id="sharedURL" value="" />
<input type="button" value="Login(first time only)" onclick="onClickLogin();" id="ButtonLogin" />
<br><br>

<div id="description2"></div>
<input type="text" size="40" id="miteneSource" value="" />
<input type="button" value="Load" onclick="onClickLoadButton();" id="ButtonLoad" />
<ul>
<li>Movie <input type="checkbox" value="Movie" onchange="onChangeMovie(this);" id="CheckboxMovie" checked />
<li>Photo <input type="checkbox" value="Photo" onchange="onChangePhoto(this);" id="CheckboxPhoto" checked />
</ul>
<input type="button" value="Download All" onclick="onClickDownloadAll();" id="ButtonDownloadAll" />

<label id="messageArea" ></label>

<BR>
<BR>
<ol>
<label id="linkToFiles" ></label>
</ol>


<P>


<pre id="output"></pre>


<script>
    let gl_allFiles = [];

    function getBrowserLanguage() {
       const language = (window.navigator.languages && window.navigator.languages[0]) ||
            window.navigator.language ||
            window.navigator.userLanguage ||
            window.navigator.browserLanguage;

       return language;
    }

    // 言語設定が日本語なら日本語、それ以外は英語として返す
    function getDisplayLanguage() {
        let displayLanguage = "";
        const browserLanguage = getBrowserLanguage();       
        if (browserLanguage == "ja") {
            displayLanguage = browserLanguage;
        }
        else {
            displayLanguage = "en_US";
        }

        return displayLanguage;
    }

    
    function enableInputs(enable) {
       document.getElementById('miteneSource').disabled = !enable;
       document.getElementById('ButtonLoad').disabled = !enable;
       document.getElementById('ButtonDownloadAll').disabled = !enable;
    }

    function onChangeMovie(value) {
       onClickLoadButton();
    }

    function onChangePhoto(value) {
       onClickLoadButton();
    }

    function isShowMovie() {
       return document.getElementById('CheckboxMovie').checked;
    }

    function isShowPhoto() {
       return document.getElementById('CheckboxPhoto').checked;
    }

    function startDownloading() {
       enableInputs(false);
    }

    function finishDownloading() {
       enableInputs(true);
    }

    function onClickLoadButton(){
      showMessage("");
      evalMitene();
    }

    function onClickDownloadAll(){
        let photoFiles = [];

        gl_allFiles.forEach(function(file) {
            photoFiles.push(file);
        });

        window.api.send("downloadAll", photoFiles );
    }

    function onClickLogin() {
        let url = document.getElementById('sharedURL').value;
		//window.location.href = url;
		window.open(url);
    }

    // textをクリップボードにコピーする
    function copyToClipboard(text) {
       let listener = function(e){

          e.clipboardData.setData("text/plain" , text);    

          // 本来のイベントをキャンセル
          e.preventDefault();

          // 終わったら削除
          document.removeEventListener("copy", listener);
       }

      // コピーのイベントが発生したときに、クリップボードに書き込むようにしておく
      document.addEventListener("copy" , listener);

      // コピー
      document.execCommand("copy");
    };

    function fixFilename(string) {
       // stringのうち、日付に相当する部分は YYYY-MM-DDTHH:mm:SS+09:00 の形式になっている
       // : と + はファイル名には使えないので削除する
       const fixed1 = string.replace("+09:00", '');  // TODO これだとタイムゾーンが変わったときにうまくいかない
       const fixed2 = fixed1.replace(/:/g, '');

       return fixed2;
    }

    function copyFileNameToClipboard(e) {
       let fileName = this.name;
       copyToClipboard(fileName);
    };

	function makeLink(mediaNo, url, fileName, username){

      let linkToFiles = document.getElementById('linkToFiles');

		//番号付きリスト
		let li = document.createElement("li");
		li.value = mediaNo;

		//クリップボード
      let button = document.createElement('button');
      button.type = 'button';
		let buttonText = document.createTextNode('ファイル名コピー');
      button.appendChild(buttonText);
      button.addEventListener("click", {name: fileName, handleEvent: copyFileNameToClipboard});
		li.appendChild( button );

		//画像のリンク追加
      let a = document.createElement("A");
      a.href = url;
      a.download = fileName;
      a.innerText = fileName;
		li.appendChild( a );

		//ファイルアップユーザID
      let user = document.createElement("A");
      user.innerText = " " + username;
		li.appendChild( user );

		linkToFiles.appendChild( li );

    }

    function enableDownloadAllButton(enable) {
      let button = document.getElementById('ButtonDownloadAll');
      button.disabled = !enable;
    }

    function enableMediaTypeCheckbox(enable) {
       // 両方 false のときに disable にすると二度と enable にできない
       if (!isShowMovie() && !isShowPhoto()) {
          return;
       }

       document.getElementById('CheckboxMovie').disabled = !enable;
       document.getElementById('CheckboxPhoto').disabled = !enable;
    }

    // 有効なリンクがあるときに押せるボタンの有効・無効を切り替える
    function enableButtonWithValidLink(enable) {
         enableDownloadAllButton(enable);
         enableMediaTypeCheckbox(enable);
    }

    function deleteAllLinks() {
         let linkToFiles = document.getElementById('linkToFiles');

         // linkToFilesのすべての子要素を削除する
         var clone = linkToFiles.cloneNode( false );
         linkToFiles.parentNode.replaceChild( clone , linkToFiles );
    }

    function deleteContents() {
         gon = {};
         gl_allFiles = [];
    }

    // 与えられた撮影時刻と同じ撮影時刻のファイルの個数を返す
    // 　調査対象：mediaFiles の先頭から mediaFileNo で指定された位置のひとつ前まで
    // 同じ撮影時刻のファイルがなければ 0
    //
    // mediaFilesは撮影時刻の新しい順に並んでいるが、番号は古いほうから 0, 1, 2 と付けたいので、
    // mediaFilesの後ろ側から探す
    function getSameTookAtNum(tookAt, mediaFiles, mediaFileNum) {

         let sameTookAt = 0;

         const mediaFilesNum = mediaFiles.length;
         for (let mediaFileNo = 0;mediaFileNo < mediaFilesNum - mediaFileNum - 1;mediaFileNo++) {
            const mediaFile = mediaFiles[mediaFilesNum - mediaFileNo - 1];  // 後ろ側からみる

            const thisTookAt = mediaFile["tookAt"];

            if (thisTookAt === tookAt) {
               sameTookAt++;
            }
         }

         return sameTookAt;
    }    

    function getPostTitle(sameTookAtNo) {
        if (sameTookAtNo <= 0) {
			return 0;
        }

        let nextSameTookAtNo = sameTookAtNo + 1;

        return "_" + nextSameTookAtNo.toString();
    }

    function evalMitene() {
         // すでに追加されているリンクは削除する
         deleteAllLinks();

         deleteContents();

         // 有効なリンクがあるときに押せるボタンを disable にする
         enableButtonWithValidLink(false);
         
         const showMovie = isShowMovie();
         const showPhoto = isShowPhoto();

         // みてねのソースの内容を評価する
         let element = document.getElementById('miteneSource');
         eval(element.value);

         // これで、 gon 以下に、みてねのデータが追加される

		const regexWebp = new RegExp('\.webp');

         // 追加されたデータを読み込む 
         const mediaFiles = gon.media["mediaFiles"];

         const mediaFileNum = mediaFiles.length;
         for (let mediaFileNo = 0;mediaFileNo < mediaFileNum;mediaFileNo++) {
            const thisMediaFile = mediaFiles[mediaFileNo];
            const uuid = thisMediaFile["uuid"];
            const tookAt = thisMediaFile["tookAt"];
            const sameTookAtNo = getSameTookAtNum(tookAt, mediaFiles, mediaFileNo); // mediaFilesの 0 - mediaFilesNo までの間に同じ tookAt がいくつあるかを返す。同じのがほかになければ 0
            let title = "";

            const mediaType = thisMediaFile["mediaType"];
            const urlPhoto = thisMediaFile["expiringUrl"];
            const urlMovie = thisMediaFile["expiringVideoUrl"];

            let url;
            let extention;
            if (mediaType === "photo") {
               if (!showPhoto) {
                  continue;
               }

               url = urlPhoto;
				if (regexWebp.test(url)) {
					extention = ".webp"
				} else {
               extention = ".jpg"
            }
			}
            else if (mediaType === "movie") {
               if (!showMovie) {
                  continue;
               }

               url = urlMovie.replace("media_files_playlist", 'media_files') + "/download";
               extention = ".mp4"
            }

            const postTitle = getPostTitle(sameTookAtNo);
            const filename = tookAt + "_" + title + postTitle + extention;

            let username;
            const userId = thisMediaFile["userId"];
            username = userId;

//            document.getElementById("output").innerHTML += mediaType + " " + filename + "  " + url + "\n";

             const fileNameFixed = fixFilename(filename);

             let file = {};
             file["url"] = url;
             file["filename"] = fileNameFixed;
             file["mediaType"] = mediaType;
             gl_allFiles.push(file);

			makeLink(mediaFileNo + 1, url, fileNameFixed, username);

         }

         // ファイルへのリンクが含まれていれば、有効なリンクがあるときに押せるボタン を有効にする      
         let hasValidLink = false;
         if (0 < gl_allFiles.length) {
            hasValidLink = true;
         }

         enableButtonWithValidLink(hasValidLink);

    }

    function showMessage(message) {
      document.getElementById("messageArea").innerHTML = message;
    }

    // ---------------------------------------------------
    // Main process からの通知を受け取る関数
    window.api.on('startDownloading', (event, argv)=>{
      startDownloading();
      showMessage(argv);
    });

    window.api.on('downloadProgress', (event, argv)=>{
      showMessage(argv);
    });

    window.api.on('finishDownloading', (event, argv)=>{
      showMessage(argv);
      finishDownloading();
    });

    window.onload = function() {
        enableButtonWithValidLink(false);
        {
			document.getElementById("description1").innerHTML = "みてねブラウザ版のURLを以下にペーストしてログインしてください。<br>※初回のみ、またはセッションが有効でないとき";
			document.getElementById("description2").innerHTML = "みてねブラウザ版のソース3行目（window.gonで始まる行）を以下にペーストして<br>Load ボタンを押してください。";
        }
    }



</script>


</body>

</html>
